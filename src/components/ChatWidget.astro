---
/**
 * ChatWidget - Lightweight Astro chatbot component
 * 
 * Vanilla JS only, no framework hydration.
 * Appears as fixed bottom-right pill on all pages.
 * Opens on demand with zero network calls until interaction.
 */

import botMark from '../assets/chatbot/bot-mark.svg';
---

<!-- Chat Widget Container -->
<div id="chat-widget" class="chat-widget-container">
  <!-- Closed State: Floating Pill -->
  <button
    id="chat-toggle"
    class="chat-toggle"
    aria-label="Open chat"
    aria-controls="chat-panel"
    aria-expanded="false"
  >
    <div class="chat-bot-icon">
      <img
        src={botMark.src}
        alt="Chat assistant"
        width="24"
        height="24"
        class="chat-bot-mark"
      />
    </div>
    <span class="chat-toggle-text">Chat with me</span>
  </button>

  <!-- Open State: Chat Panel -->
  <div
    id="chat-panel"
    class="chat-panel"
    role="complementary"
    aria-label="Chat with Global Restoration Assistant"
    hidden
  >
    <!-- Header -->
    <div class="chat-header">
      <div class="chat-header-title">
        <div class="chat-bot-icon chat-bot-icon-sm">
          <img
            src={botMark.src}
            alt="Assistant"
            width="20"
            height="20"
            class="chat-bot-mark"
          />
        </div>
        <span>Global Restoration Assistant</span>
      </div>
      <button
        id="chat-close"
        class="chat-close-btn"
        aria-label="Close chat"
        aria-controls="chat-panel"
      >
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="chat-messages"></div>

    <!-- Input -->
    <div class="chat-input-area">
      <textarea
        id="chat-input"
        class="chat-textarea"
        placeholder="Ask about roofing, water damage, siding, or gutters..."
        rows="2"
        maxlength="1000"
      ></textarea>
      <button
        id="chat-send"
        class="chat-send-btn"
        aria-label="Send message"
        type="button"
      >
        <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
          <path d="M16.6 0.3c0.4-0.2 0.9 0 1.1 0.4c0.2 0.4 0 0.9-0.4 1.1l-15 7.5l15 7.5c0.4 0.2 0.6 0.7 0.4 1.1c-0.2 0.4-0.7 0.6-1.1 0.4l-16-8c-0.3-0.2-0.5-0.5-0.5-0.8c0-0.3 0.2-0.6 0.5-0.8l16-8z" />
        </svg>
      </button>
    </div>

    <!-- Transcript Actions -->
    <div class="chat-actions">
      <button
        id="chat-email-btn"
        class="chat-action-btn"
        aria-label="Email chat transcript"
        type="button"
        title="Send transcript to email"
      >
        ðŸ“§ Email
      </button>
      <button
        id="chat-copy-btn"
        class="chat-action-btn"
        aria-label="Copy chat transcript to clipboard"
        type="button"
        title="Copy to clipboard"
      >
        ðŸ“‹ Copy
      </button>
    </div>
  </div>
</div>

<style>
  /* Chat Widget Container */
  .chat-widget-container {
    position: fixed;
    bottom: 2rem;
    right: 1.5rem;
    z-index: 50;
    font-family: system-ui, -apple-system, sans-serif;
  }

  /* Closed State - Floating Pill Button */
  .chat-toggle {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    transition: transform 0.2s, box-shadow 0.2s;
    white-space: nowrap;
    min-height: 44px;
  }

  .chat-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
  }

  .chat-toggle:active {
    transform: scale(0.98);
  }

  .chat-toggle:focus {
    outline: 2px solid #fbbf24;
    outline-offset: 2px;
  }

  /* Bot Icon - Black Circle with White SVG */
  .chat-bot-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .chat-bot-icon-sm {
    width: 28px;
    height: 28px;
  }

  .chat-bot-mark {
    width: 100%;
    height: 100%;
  }

  /* Open State - Chat Panel */
  .chat-panel {
    position: absolute;
    bottom: 5.5rem;
    right: 0;
    width: 360px;
    max-height: 550px;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
    border: 1px solid #e5e7eb;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
  }

  @media (max-width: 480px) {
    .chat-panel {
      width: calc(100vw - 2rem);
      max-width: 360px;
      right: -1rem;
    }
  }

  .chat-panel[hidden] {
    display: none;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Header */
  .chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    border-bottom: 1px solid #e5e7eb;
  }

  .chat-header-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .chat-close-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background-color 0.2s;
    min-height: 32px;
    min-width: 32px;
  }

  .chat-close-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .chat-close-btn:focus {
    outline: 2px solid #fbbf24;
    outline-offset: -2px;
  }

  /* Messages Container */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Message Bubbles */
  .chat-message {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .chat-message.user {
    align-items: flex-end;
  }

  .chat-message-content {
    max-width: 85%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .chat-message.user .chat-message-content {
    background: #ef4444;
    color: white;
    border-bottom-right-radius: 4px;
  }

  .chat-message.assistant .chat-message-content {
    background: #f3f4f6;
    color: #1f2937;
    border-bottom-left-radius: 4px;
  }

  /* Disclaimer text under bot messages */
  .chat-message-disclaimer {
    font-size: 0.7rem;
    color: #9ca3af;
    margin-top: 0.25rem;
    font-style: italic;
    max-width: 85%;
  }

  .chat-message.assistant .chat-message-disclaimer {
    align-self: flex-start;
    margin-left: 0.5rem;
  }

  .chat-input-area {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    background: #fafafa;
  }

  .chat-textarea {
    flex: 1;
    padding: 0.625rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.875rem;
    resize: none;
    line-height: 1.4;
  }

  .chat-textarea:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 0;
    border-color: #3b82f6;
  }

  .chat-send-btn {
    flex-shrink: 0;
    padding: 0.625rem 0.875rem;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    min-height: 36px;
    min-width: 36px;
  }

  .chat-send-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  .chat-send-btn:active {
    transform: scale(0.95);
  }

  .chat-send-btn:focus {
    outline: 2px solid #fbbf24;
    outline-offset: 2px;
  }

  .chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Transcript Actions */
  .chat-actions {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
    justify-content: flex-end;
  }

  .chat-action-btn {
    padding: 0.5rem 0.875rem;
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .chat-action-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  .chat-action-btn:active {
    transform: scale(0.97);
  }

  .chat-action-btn:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 1px;
  }

  .chat-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Loading Indicator */
  .chat-loading {
    display: flex;
    gap: 0.375rem;
  }

  .chat-loading-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #9ca3af;
    animation: bounce 1.4s infinite;
  }

  .chat-loading-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .chat-loading-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%,
    80%,
    100% {
      opacity: 0.5;
    }
    40% {
      opacity: 1;
    }
  }

  /* Scrollbar styling */
  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  .chat-messages::-webkit-scrollbar-track {
    background: #f3f4f6;
  }

  .chat-messages::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
  }

  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>

<script>
  // Vanilla JS - no framework, minimal DOM manipulation
  interface Message {
    role: 'user' | 'assistant';
    content: string;
  }

  class ChatWidget {
    private toggleBtn: HTMLButtonElement | null;
    private closeBtn: HTMLButtonElement | null;
    private panel: HTMLDivElement | null;
    private messagesContainer: HTMLDivElement | null;
    private textarea: HTMLTextAreaElement | null;
    private sendBtn: HTMLButtonElement | null;
    private emailBtn: HTMLButtonElement | null;
    private copyBtn: HTMLButtonElement | null;
    private conversationHistory: Message[] = [];
    private isLoading = false;
    private readonly SESSION_KEY = 'gr_chat_session';
    private readonly MAX_HISTORY = 10;
    private readonly DISCLAIMER = 'Disclaimer: Please verify all information with an authorized Global Restoration agent.';

    constructor() {
      this.toggleBtn = document.getElementById('chat-toggle') as HTMLButtonElement;
      this.closeBtn = document.getElementById('chat-close') as HTMLButtonElement;
      this.panel = document.getElementById('chat-panel') as HTMLDivElement;
      this.messagesContainer = document.getElementById('chat-messages') as HTMLDivElement;
      this.textarea = document.getElementById('chat-input') as HTMLTextAreaElement;
      this.sendBtn = document.getElementById('chat-send') as HTMLButtonElement;
      this.emailBtn = document.getElementById('chat-email-btn') as HTMLButtonElement;
      this.copyBtn = document.getElementById('chat-copy-btn') as HTMLButtonElement;

      this.loadHistory();
      this.attachEventListeners();
      this.renderHistory();
    }

    private attachEventListeners(): void {
      this.toggleBtn?.addEventListener('click', () => this.openChat());
      this.closeBtn?.addEventListener('click', () => this.closeChat());
      this.sendBtn?.addEventListener('click', () => this.sendMessage());
      this.emailBtn?.addEventListener('click', () => this.emailTranscript());
      this.copyBtn?.addEventListener('click', () => this.copyTranscript());
      this.textarea?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });

      // Close on ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !this.panel?.hidden) {
          this.closeChat();
        }
      });
    }

    private openChat(): void {
      if (this.panel) {
        this.panel.hidden = false;
        this.toggleBtn?.setAttribute('aria-expanded', 'true');
        this.textarea?.focus();
      }
    }

    private closeChat(): void {
      if (this.panel) {
        this.panel.hidden = true;
        this.toggleBtn?.setAttribute('aria-expanded', 'false');
      }
    }

    private async sendMessage(): Promise<void> {
      const message = this.textarea?.value.trim();
      if (!message || this.isLoading) return;

      // Clear input
      if (this.textarea) {
        this.textarea.value = '';
      }

      // Add user message to history and render
      this.conversationHistory.push({ role: 'user', content: message });
      this.addMessageToDOM('user', message);
      this.saveHistory();

      // Show loading indicator briefly, then show offline message
      this.isLoading = true;
      this.addLoadingIndicator();
      this.sendBtn!.disabled = true;

      // Simulate a short delay for better UX
      await new Promise((resolve) => setTimeout(resolve, 800));

      try {
        this.removeLoadingIndicator();

        // Offline message - no API call
        const offlineMsg = 'Our chat service is temporarily unavailable. Please call 888-370-9899 for immediate assistance, or check back soon!';
        this.conversationHistory.push({ role: 'assistant', content: offlineMsg });
        this.addMessageToDOM('assistant', offlineMsg);
        this.saveHistory();

        // Keep history size reasonable
        if (this.conversationHistory.length > this.MAX_HISTORY * 2) {
          this.conversationHistory = this.conversationHistory.slice(
            -this.MAX_HISTORY * 2
          );
          this.saveHistory();
        }
      } catch (error) {
        this.removeLoadingIndicator();
        const errorMsg = 'Chat is currently unavailable. Please check back later.';
        this.conversationHistory.push({ role: 'assistant', content: errorMsg });
        this.addMessageToDOM('assistant', errorMsg);
        this.saveHistory();
      } finally {
        this.isLoading = false;
        this.sendBtn!.disabled = false;
        this.textarea?.focus();
      }
    }

    private addMessageToDOM(role: 'user' | 'assistant', content: string): void {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'chat-message-content';
      contentDiv.textContent = content; // textContent is safe, no XSS

      messageDiv.appendChild(contentDiv);

      // Add disclaimer for bot messages
      if (role === 'assistant') {
        const disclaimerDiv = document.createElement('div');
        disclaimerDiv.className = 'chat-message-disclaimer';
        disclaimerDiv.textContent = this.DISCLAIMER;
        messageDiv.appendChild(disclaimerDiv);
      }

      this.messagesContainer?.appendChild(messageDiv);

      // Scroll to bottom
      if (this.messagesContainer) {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
      }
    }

    private addLoadingIndicator(): void {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'chat-message assistant';
      loadingDiv.id = 'chat-loading';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'chat-message-content chat-loading';

      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'chat-loading-dot';
        contentDiv.appendChild(dot);
      }

      loadingDiv.appendChild(contentDiv);
      this.messagesContainer?.appendChild(loadingDiv);

      if (this.messagesContainer) {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
      }
    }

    private removeLoadingIndicator(): void {
      const loading = document.getElementById('chat-loading');
      loading?.remove();
    }

    private buildTranscript(): string {
      const pageUrl = window.location.href;
      const timestamp = new Date().toLocaleString();
      let transcript = `Global Restoration Chat Transcript\n`;
      transcript += `Date: ${timestamp}\n`;
      transcript += `Page: ${pageUrl}\n`;
      transcript += `\n---\n\n`;

      for (const msg of this.conversationHistory) {
        const role = msg.role === 'user' ? 'You' : 'Assistant';
        transcript += `${role}:\n${msg.content}\n\n`;
      }

      transcript += `---\n${this.DISCLAIMER}`;
      return transcript;
    }

    private emailTranscript(): void {
      const transcript = this.buildTranscript();
      const subject = 'Global Restoration Chat Transcript';
      const body = encodeURIComponent(transcript);
      const mailto = `mailto:web@globalrestorationky.us?subject=${encodeURIComponent(subject)}&body=${body}`;

      try {
        window.location.href = mailto;
      } catch (error) {
        // Fallback: copy to clipboard if mailto fails
        this.copyTranscript();
      }
    }

    private copyTranscript(): void {
      const transcript = this.buildTranscript();

      try {
        navigator.clipboard.writeText(transcript).then(() => {
          // Show feedback
          const originalText = this.copyBtn!.textContent;
          this.copyBtn!.textContent = 'âœ“ Copied!';
          setTimeout(() => {
            this.copyBtn!.textContent = originalText;
          }, 2000);
        });
      } catch (error) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = transcript;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        const originalText = this.copyBtn!.textContent;
        this.copyBtn!.textContent = 'âœ“ Copied!';
        setTimeout(() => {
          this.copyBtn!.textContent = originalText;
        }, 2000);
      }
    }

    private loadHistory(): void {
      const saved = sessionStorage.getItem(this.SESSION_KEY);
      if (saved) {
        try {
          this.conversationHistory = JSON.parse(saved);
        } catch {
          this.conversationHistory = [];
        }
      }
    }

    private saveHistory(): void {
      sessionStorage.setItem(this.SESSION_KEY, JSON.stringify(this.conversationHistory));
    }

    private renderHistory(): void {
      this.conversationHistory.forEach((msg) => {
        this.addMessageToDOM(msg.role, msg.content);
      });
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new ChatWidget();
    });
  } else {
    new ChatWidget();
  }
</script>
